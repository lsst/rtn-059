:tocdepth: 1

.. sectnum::

Introduction
============

This document describes the implementation plan by which we will enact the data retention policies described
by the Vera C. Rubin Observatory Data Management team in RTN-054. I will elaborate in turn upon each of the
data tiers (Raw, Analysis, Service, Staff) described in the previous document, with the goal of concretizing
the processes by which data will be retained in a manner that satisfies the needs of the Observatory. This
document assumes an understanding of the Rucio service as described in DMTN-213.

Tape Considerations
===================

The current most cost-effective medium to store the volume of information generated by the Rubin Observatory
for a long period of time is the tape medium. The current standard in tape media is the LTO9 cartridge, which
provides ~45TB of compressed data storage and up to ~18TB uncompressed. However, the information on tape can
degrade over time due to wear caused by mounting tapes on physical spindles and reading them, improper
storage, or be destroyed outright by other errors or catastrophes. Therefore in order to maintain the integrity of
the data for this period of time it will be intermittently required that the data is migrated to newer storage
media. These migration periods provide a convenient point at which point data from multiple tapes may be
consolidated onto fewer newer tapes. An important point considering migration is that the advertised archival
lifetime of LTO9 tape media is 30 years. This is an upper bound on the lifetime of a tape that must be
respected, as even in the absence of mount and read operations the continued veracity of the data may not be
guaranteed beyond this time. One final point is that continual migration of the data to newer types of storage
media ensures that if reading the data is necessary 90 years or more from now, locating antique physical
drives to read the tapes is not required.

As a National Laboratory, SLAC is uniquely positioned to ensure the continued care and availability that this
data requires. SLAC maintains an IBM High Performance Storage System (HPSS) tape archive on-premises which
will serve to enable long-term data archival for Rubin. HPSS has a disk-buffer front end, which acts as a
repository for data to be written to or read from. Regarding the ingest of data to the HPSS system; while the
disparate types of data that are destined may take different paths to arrive in that HPSS disk buffer, once
the data (in this case a single file) arrives it should be registered as a file replica in the Rucio database
as now being presently located at the SLAC HPSS Rucio Storage Element (RSE). 

Tape based storage elements are a well-developed use case for Rucio, and take the form of a non-deterministic
Rucio Storage Element where explicit Physical File Names (PFNs) are provided to Rucio by the client, rather
than being generated by an algorithm deterministically. The differences between a deterministic and
non-deterministic RSE lie in the manner by which paths to transfer destinations are generated. In a Rucio
Storage Element configured with a deterministic data placement algorithm, data is placed in a destination
directory path specified by a hash function. The input to this function includes the scope and name of the
file as input. By default in Rucio, data is placed by taking a hash of the combined `scope:filename`, then
using the first two output hash digits to name a first tier directory inside the storage for a given scope.
The next two digits are used as a subdirectory of the first. This method generates an acceptably balanced tree
as the data is placed. In a non-deterministic Storage Element however, the destination file paths are
generated by a user-specified Logical File Name (composed of scope:name) to Physical File Name (lfn2pfn)
algorithm. This algorithm may by design take many forms, for example utilizing custom logic such as metadata
queries to external services in order to generate an informative PFN which conveys about a file to a user by
its location.

Rucio has the ability to work with FTS3 and tape storage systems to orchestrate retrieval of data from tape,
loading the information to disk (platter, SSD, NVME, etc.) for user usage. One consideration is that as the
Rucio database is currently slated to be the Observatory’s repository of data replica information, if a
deterministic data placement algorithm is used for archival in HPSS it would be necessary that the Rucio
database information be retained for as long as the Raw tier information persists in order to locate it at a
later time. Instead, with the usage of a non-deterministic RSE it is possible that this requirement may be
avoided. Careful placement of data at human-readable file paths rather than paths created from a hash allows
for a permanently navigable structure for the data, without the requirement of maintaining the Rucio replica
database. In this manner, continued support of a running Rucio service or preservation of the database for the
duration of the Raw information’s lifetime may be avoided, minimizing both long-term cost and effort.

Raw Data
========

As previously described in RTN-054, raw data tier information is critical to the successful operation of the
Observatory. As such, the highest standards of data retention should be enacted upon this tier. Data belonging
to the Raw tier should be maintained in a dual-copy fashion for a minimum period of 100 years. Policy states
that SLAC must maintain a full copy of the Raw data. After Raw data of any form is created, that information
should be transferred to SLAC in an expedient fashion. In most cases for Raw data the mechanism of transfer
will be via the Rucio and FTS3 workflow described in DMTN-213. The destination transfer location for this data
at SLAC will be the disk-based buffer of HPSS, where it will be migrated to tape automatically by HPSS. A
replication factor setting of at least 2 in HPSS should be configured for Raw tier data, ensuring that data is
placed on at least two disparate tapes with each discrete tape residing in an independent tape library. If
possible, these tape libraries should be geographically distributed to protect from natural catastrophes,
wars, or other unforeseen circumstances. Once the data has been migrated to the archival tape-based storage
and is dually replicated, it may safely removed from the front-end disk buffer of HPSS.


Analysis Data
=============

In the case of the Analysis classification tier data need only be retained for a period of 10 years, rather
than the 100 year requirement placed upon data classified at the Raw level. In the case of Analysis data,
policy dictates that both the United States and French Data Facilities keep a full copy of all information. In
this case, as with Raw information, once again the HPSS at SLAC should be utilized for long-term data
archival. Unlike the Raw tier however, data classified as belonging to the Analysis tier has no requirement
that it be stored in a dual-copy fashion. This loosening of restrictions is desirable for its effect in
decreasing the amount of total storage used to store Analysis tier data by a factor of two. Usage of this
space-saving method is permissible due the the fact that Analysis data, if lost, may be regenerated from Raw
tier inputs. 

Once again, various methods of transferring data to HPSS may be utilized. The vital action that must be taken
is that file replicas corresponding to the new tape locations are declared in the Rucio database. As with Raw
tier data, this data is registered at a non-deterministic Rucio Storage Element that corresponds to SLAC HPSS.


Service Data
============

Service data, as described in RTN-054 is composed of data that must be maintained in order to prevent a
catastrophic data loss that impacts Observatory operations. The lifetime that Service Data should be retained
for is wholly dependent on the particulars of the service. As Service Data might well become unneeded far
quicker than the Analysis or Raw tiers, use of some sort of “purge policy” functionality in HPSS to enforce
hard lifetimes on data, unless proven to still be required, should be compulsory. In some cases however,
backups for services such as the Data Butler, PanDA or potentially even Rucio or FTS3 will need to be
maintained for the duration of Observatory operations. In the case where backups are required of these service
databases, a simple solution may be to compress the database in its entirety into a single file, and store
that on tape via Rucio utilizing processes described earlier in this document. As Service Data may not be
regenerated if lost, Service Data of critical importance should be stored in a dual-copy fashion, once again.

Staff Data
==========

The exact form that information of the Staff tier will take will become apparent as the Observatory generates
additional data, and further need for backups of specific datasets is identified. As with the Service Data
tier, the period for which the data will be retained must be determined based on the specifics of that data’s
continued value to the Observatory. Only critical data need be backed up to tape, and dual-copy restrictions
will only apply if deemed necessary. Unlike the Raw and Analysis data tiers, the complete dimensions of the Staff Data 
that will require backup is not known ahead of time. This unknown parameter implies that a backup operation, as
opposed to archival will be required, where a snapshotting scheme is used. These backups may be performed via
configuration of the Tivoli Storage Manager (TSM) service that is maintained by SLAC. This is the same mechanism by
which the S3DF user home areas are backed up. TSM supports functionality that enables backup up files to tape 
archives, including a declarative policy that allows for specification of a data retention period. 
